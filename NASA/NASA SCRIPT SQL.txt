CREATE DATABASE PAR_A01_2018_Inventory


USE PAR_A01_2018_Inventory
SELECT * FROM [PAR_A01_2018_Inventory (3)]

SELECT TOP 10  * FROM [PAR_A01_2018_Inventory (3)]

SELECT SUM(DBH) FROM [PAR_A01_2018_Inventory (3)]

ALTER TABLE [PAR_A01_2018_Inventory (3)]
ALTER COLUMN DBH FLOAT

BEGIN

@TOTAL INT = 

CREATE TABLE TEMPNOTDEADFOREST(
	QUANTITY INT,
	COMMON_NAME VARCHAR(50),
	FAMILY_NAME VARCHAR(50),
	DEAD VARCHAR(5)
)

INSERT INTO TEMPNOTDEADFOREST (QUANTITY, COMMON_NAME, FAMILY_NAME, DEAD) 
SELECT COUNT([common name]), [common name], [family name], [Dead] FROM [PAR_A01_2018_Inventory (3)]
WHERE [Dead] = 'FALSE'
GROUP BY [common name], [family name], [Dead]

CREATE TABLE TEMPDEADFOREST(
	QUANTITY INT,
	COMMON_NAME VARCHAR(50),
	FAMILY_NAME VARCHAR(50),
	DEAD VARCHAR(5)
)



INSERT INTO TEMPDEADFOREST (QUANTITY, COMMON_NAME, FAMILY_NAME, DEAD) 
SELECT COUNT([common name]), [common name], [family name], [Dead] FROM [PAR_A01_2018_Inventory (3)]
WHERE [Dead] = 'TRUE'
GROUP BY [common name], [family name], [Dead]

DELETE FROM TEMPDEADFOREST

SELECT * FROM TEMPNOTDEADFOREST
SELECT * FROM TEMPDEADFOREST


SELECT ((CAST(TP_DEAD.QUANTITY AS FLOAT)/CAST((TP_NOTDEAD.QUANTITY + TP_DEAD.QUANTITY) AS FLOAT))) AS 'Porcentagem' FROM TEMPDEADFOREST TP_DEAD
RIGHT JOIN TEMPNOTDEADFOREST TP_NOTDEAD
ON TP_DEAD.COMMON_NAME = TP_NOTDEAD.COMMON_NAME
INNER JOIN [PAR_A01_2018_Inventory].[dbo].[treecover_loss__ha] tr
ON TP_NOTDEAD.iso = tr.iso
WHERE TP_DEAD.COMMON_NAME = 'mapatirana'
AND tr.umd_tree_cover_loss__year = '2018'

ALTER TABLE TEMPNOTDEADFOREST
ADD iso VARCHAR (50)

UPDATE  TEMPNOTDEADFOREST SET iso = 'BRA' 

CREATE TABLE TB_EVENT(
	PORCENTAGEM FLOAT,
	COMMON_NAME VARCHAR(50)
)

DROP TRIGGER TR_EVENT

CREATE TRIGGER TR_EVENT 
ON TEMPDEADFOREST
AFTER INSERT, UPDATE 
AS
BEGIN
    DECLARE @PORCENTAGEM FLOAT

    SELECT @PORCENTAGEM = 
        (SELECT CAST((TP_DEAD.QUANTITY * 1.0) / (TP_NOTDEAD.QUANTITY + TP_DEAD.QUANTITY) AS FLOAT) AS 'Porcentagem' 
        FROM TEMPDEADFOREST TP_DEAD
        RIGHT JOIN TEMPNOTDEADFOREST TP_NOTDEAD ON TP_DEAD.COMMON_NAME = TP_NOTDEAD.COMMON_NAME
        INNER JOIN [PAR_A01_2018_Inventory].[dbo].[treecover_loss__ha] tr ON TP_NOTDEAD.iso = tr.iso
        WHERE TP_DEAD.COMMON_NAME = 'mapatirana'
        AND tr.umd_tree_cover_loss__year = '2018')

    IF @PORCENTAGEM > 0.10
    BEGIN
        INSERT INTO TB_EVENT (PORCENTAGEM, COMMON_NAME) -- Replace ColumnName1 and ColumnName2 with the actual column names in TB_EVENT table
        VALUES (@PORCENTAGEM, 'mapatirana')
    END 
END

SELECT * FROM TEMPDEADFOREST
UPDATE TEMPDEADFOREST SET QUANTITY = 2
where COMMON_NAME = 'maparatina'

select * from TB_EVENT